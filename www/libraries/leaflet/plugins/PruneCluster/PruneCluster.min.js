var __extends=this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);i.prototype=e.prototype,t.prototype=new i},PruneCluster;!function(t){function e(t,e){return t.lat>=e.minLat&&t.lat<=e.maxLat&&t.lng>=e.minLng&&t.lng<=e.maxLng}function i(t){for(var e,i,s,r=1,o=t.length;o>r;++r){for(i=t[r],s=i.position.lng,e=r-1;e>=0&&t[e].position.lng>s;--e)t[e+1]=t[e];t[e+1]=i}}var s=.2,r=function(){function t(){}return t}();t.Point=r;var o=function(){function t(){}return t}();t.ClusterObject=o;var a=1,n=Math.pow(2,53)-1,l=function(t){function e(e,i,s,r,o,n){void 0===s&&(s={}),void 0===o&&(o=1),void 0===n&&(n=!1),t.call(this),this.data=s,this.position={lat:+e,lng:+i},this.weight=o,this.category=r,this.filtered=n,this.hashCode=a++}return __extends(e,t),e.prototype.Move=function(t,e){this.position.lat=+t,this.position.lng=+e},e.prototype.SetData=function(t){for(var e in t)this.data[e]=t[e]},e}(o);t.Marker=l;var h=function(t){function e(i){return t.call(this),this.stats=[0,0,0,0,0,0,0,0],this.data={},i?(e.ENABLE_MARKERS_LIST&&(this._clusterMarkers=[i]),this.lastMarker=i,this.hashCode=31+i.hashCode,this.population=1,void 0!==i.category&&(this.stats[i.category]=1),this.totalWeight=i.weight,this.position={lat:i.position.lat,lng:i.position.lng},void(this.averagePosition={lat:i.position.lat,lng:i.position.lng})):(this.hashCode=1,void(e.ENABLE_MARKERS_LIST&&(this._clusterMarkers=[])))}return __extends(e,t),e.prototype.AddMarker=function(t){e.ENABLE_MARKERS_LIST&&this._clusterMarkers.push(t);var i=this.hashCode;i=(i<<5)-i+t.hashCode,this.hashCode=i>=n?i%n:i,this.lastMarker=t;var s=t.weight,r=this.totalWeight,o=s+r;this.averagePosition.lat=(this.averagePosition.lat*r+t.position.lat*s)/o,this.averagePosition.lng=(this.averagePosition.lng*r+t.position.lng*s)/o,++this.population,this.totalWeight=o,void 0!==t.category&&(this.stats[t.category]=this.stats[t.category]+1||1)},e.prototype.Reset=function(){this.hashCode=1,this.lastMarker=void 0,this.population=0,this.totalWeight=0,this.stats=[0,0,0,0,0,0,0,0],e.ENABLE_MARKERS_LIST&&(this._clusterMarkers=[])},e.prototype.ComputeBounds=function(t){var e=t.Project(this.position.lat,this.position.lng),i=t.Size,s=Math.floor(e.x/i),r=Math.floor(e.y/i),o=s*i,a=r*i,n=t.UnProject(o,a),l=t.UnProject(o+i,a+i);this.bounds={minLat:l.lat,maxLat:n.lat,minLng:n.lng,maxLng:l.lng}},e.prototype.GetClusterMarkers=function(){return this._clusterMarkers},e.prototype.ApplyCluster=function(t){this.hashCode=41*this.hashCode+43*t.hashCode,this.hashCode>n&&(this.hashCode=this.hashCode=n);var i=t.totalWeight,s=this.totalWeight,r=i+s;this.averagePosition.lat=(this.averagePosition.lat*s+t.averagePosition.lat*i)/r,this.averagePosition.lng=(this.averagePosition.lng*s+t.averagePosition.lng*i)/r,this.population+=t.population,this.totalWeight=r,this.bounds.minLat=Math.min(this.bounds.minLat,t.bounds.minLat),this.bounds.minLng=Math.min(this.bounds.minLng,t.bounds.minLng),this.bounds.maxLat=Math.max(this.bounds.maxLat,t.bounds.maxLat),this.bounds.maxLng=Math.max(this.bounds.maxLng,t.bounds.maxLng);for(var o in t.stats)t.stats.hasOwnProperty(o)&&(this.stats.hasOwnProperty(o)?this.stats[o]+=t.stats[o]:this.stats[o]=t.stats[o]);e.ENABLE_MARKERS_LIST&&(this._clusterMarkers=this._clusterMarkers.concat(t.GetClusterMarkers()))},e.ENABLE_MARKERS_LIST=!1,e}(o);t.Cluster=h;var u=function(){function t(){this._markers=[],this._nbChanges=0,this._clusters=[],this.Size=166,this.ViewPadding=.2}return t.prototype.RegisterMarker=function(t){t._removeFlag&&delete t._removeFlag,this._markers.push(t),this._nbChanges+=1},t.prototype._sortMarkers=function(){var t=this._markers,e=t.length;this._nbChanges&&(!e||this._nbChanges/e>s)?this._markers.sort(function(t,e){return t.position.lng-e.position.lng}):i(t),this._nbChanges=0},t.prototype._sortClusters=function(){i(this._clusters)},t.prototype._indexLowerBoundLng=function(t){for(var e,i,s=this._markers,r=0,o=s.length;o>0;)i=Math.floor(o/2),e=r+i,s[e].position.lng<t?(r=++e,o-=i+1):o=i;return r},t.prototype._resetClusterViews=function(){for(var t=0,e=this._clusters.length;e>t;++t){var i=this._clusters[t];i.Reset(),i.ComputeBounds(this)}},t.prototype.ProcessView=function(t){var i=Math.abs(t.maxLat-t.minLat)*this.ViewPadding,s=Math.abs(t.maxLng-t.minLng)*this.ViewPadding,r={minLat:t.minLat-i-i,maxLat:t.maxLat+i+i,minLng:t.minLng-s-s,maxLng:t.maxLng+s+s};this._sortMarkers(),this._resetClusterViews();for(var o=this._indexLowerBoundLng(r.minLng),a=this._markers,n=this._clusters,l=n.slice(0),u=o,p=a.length;p>u;++u){var d=a[u],m=d.position;if(m.lng>r.maxLng)break;if(m.lat>r.minLat&&m.lat<r.maxLat&&!d.filtered){for(var _,c=!1,f=0,g=l.length;g>f;++f)if(_=l[f],_.bounds.maxLng<d.position.lng)l.splice(f,1),--f,--g;else if(e(m,_.bounds)){_.AddMarker(d),c=!0;break}c||(_=new h(d),_.ComputeBounds(this),n.push(_),l.push(_))}}var L=[];for(u=0,p=n.length;p>u;++u)_=n[u],_.population>0&&L.push(_);return this._clusters=L,this._sortClusters(),this._clusters},t.prototype.RemoveMarkers=function(t){if(!t)return void(this._markers=[]);for(var e=0,i=t.length;i>e;++e)t[e]._removeFlag=!0;var s=[];for(e=0,i=this._markers.length;i>e;++e)this._markers[e]._removeFlag||s.push(this._markers[e]);this._markers=s},t.prototype.FindMarkersInArea=function(t){for(var e=t.minLat,i=t.maxLat,s=t.minLng,r=t.maxLng,o=this._markers,a=[],n=this._indexLowerBoundLng(s),l=n,h=o.length;h>l;++l){var u=o[l].position;if(u.lng>r)break;u.lat>=e&&u.lat<=i&&u.lng>=s&&a.push(o[l])}return a},t.prototype.ComputeBounds=function(t){if(!t||!t.length)return null;for(var e=Number.MAX_VALUE,i=-Number.MAX_VALUE,s=Number.MAX_VALUE,r=-Number.MAX_VALUE,o=0,a=t.length;a>o;++o){var n=t[o].position;n.lat<e&&(e=n.lat),n.lat>i&&(i=n.lat),n.lng<s&&(s=n.lng),n.lng>r&&(r=n.lng)}return{minLat:e,maxLat:i,minLng:s,maxLng:r}},t.prototype.FindMarkersBoundsInArea=function(t){return this.ComputeBounds(this.FindMarkersInArea(t))},t.prototype.ComputeGlobalBounds=function(){return this.ComputeBounds(this._markers)},t.prototype.GetMarkers=function(){return this._markers},t.prototype.GetPopulation=function(){return this._markers.length},t.prototype.ResetClusters=function(){this._clusters=[]},t}();t.PruneCluster=u}(PruneCluster||(PruneCluster={}));var PruneCluster;!function(){}(PruneCluster||(PruneCluster={}));var PruneClusterForLeaflet=(L.Layer?L.Layer:L.Class).extend({initialize:function(t,e){var i=this;void 0===t&&(t=120),void 0===e&&(e=20),this.Cluster=new PruneCluster.PruneCluster,this.Cluster.Size=t,this.clusterMargin=Math.min(e,t/4),this.Cluster.Project=function(t,e){return i._map.project(new L.LatLng(t,e))},this.Cluster.UnProject=function(t,e){return i._map.unproject(new L.Point(t,e))},this._objectsOnMap=[],this.spiderfier=new PruneClusterLeafletSpiderfier(this),this._hardMove=!1,this._resetIcons=!1,this._removeTimeoutId=0,this._markersRemoveListTimeout=[]},RegisterMarker:function(t){this.Cluster.RegisterMarker(t)},RemoveMarkers:function(t){this.Cluster.RemoveMarkers(t)},BuildLeafletCluster:function(t,e){var i=this,s=new L.Marker(e,{icon:this.BuildLeafletClusterIcon(t)});return s.on("click",function(){var r=i.Cluster.FindMarkersInArea(t.bounds),o=i.Cluster.ComputeBounds(r);if(o){var a=new L.LatLngBounds(new L.LatLng(o.minLat,o.maxLng),new L.LatLng(o.maxLat,o.minLng)),n=i._map.getZoom(),l=i._map.getBoundsZoom(a,!1,new L.Point(20,20));l===n?(i._map.fire("overlappingmarkers",{cluster:i,markers:r,center:s.getLatLng(),marker:s}),i._map.setView(e,l)):i._map.fitBounds(a)}}),s},BuildLeafletClusterIcon:function(t){var e="prunecluster prunecluster-",i=38,s=this.Cluster.GetPopulation();return t.population<Math.max(10,.01*s)?e+="small":t.population<Math.max(100,.05*s)?(e+="medium",i=40):(e+="large",i=44),new L.DivIcon({html:"<div><span>"+t.population+"</span></div>",className:e,iconSize:L.point(i,i)})},BuildLeafletMarker:function(t,e){var i=new L.Marker(e);return this.PrepareLeafletMarker(i,t.data,t.category),i},PrepareLeafletMarker:function(t,e,i){if(e.icon&&t.setIcon("function"==typeof e.icon?e.icon(e,i):e.icon),e.popup){var s="function"==typeof e.popup?e.popup(e,i):e.popup;t.getPopup()?t.setPopupContent(s,e.popupOptions):t.bindPopup(s,e.popupOptions)}},onAdd:function(t){this._map=t,t.on("movestart",this._moveStart,this),t.on("moveend",this._moveEnd,this),t.on("zoomend",this._zoomStart,this),t.on("zoomend",this._zoomEnd,this),this.ProcessView(),t.addLayer(this.spiderfier)},onRemove:function(t){t.off("movestart",this._moveStart,this),t.off("moveend",this._moveEnd,this),t.off("zoomend",this._zoomStart,this),t.off("zoomend",this._zoomEnd,this);for(var e=0,i=this._objectsOnMap.length;i>e;++e)t.removeLayer(this._objectsOnMap[e].data._leafletMarker);this._objectsOnMap=[],this.Cluster.ResetClusters(),t.removeLayer(this.spiderfier),this._map=null},_moveStart:function(){this._moveInProgress=!0},_moveEnd:function(t){this._moveInProgress=!1,this._hardMove=t.hard,this.ProcessView()},_zoomStart:function(){this._zoomInProgress=!0},_zoomEnd:function(){this._zoomInProgress=!1,this.ProcessView()},ProcessView:function(){var t=this;if(this._map&&!this._zoomInProgress&&!this._moveInProgress){for(var e=this._map,i=e.getBounds(),s=e.getZoom(),r=this.clusterMargin/this.Cluster.Size,o=this._resetIcons,a=i.getSouthWest(),n=i.getNorthEast(),l=this.Cluster.ProcessView({minLat:a.lat,minLng:a.lng,maxLat:n.lat,maxLng:n.lng}),h=this._objectsOnMap,u=[],p=new Array(h.length),d=0,m=h.length;m>d;++d){var _=h[d].data._leafletMarker;p[d]=_,_._removeFromMap=!0}var c=[],f=[],g=[];for(d=0,m=l.length;m>d;++d){for(var v=l[d],M=v.data,C=(v.bounds.maxLat-v.bounds.minLat)*r,k=(v.bounds.maxLng-v.bounds.minLng)*r,P=0,y=g.length;y>P;++P){var w=g[P];if(w.bounds.maxLng<v.bounds.minLng)g.splice(P,1),--P,--y;else{var b=w.averagePosition.lng+k,x=w.averagePosition.lat-C,I=w.averagePosition.lat+C,S=v.averagePosition.lng-k,B=v.averagePosition.lat-C,R=v.averagePosition.lat+C;if(b>S&&I>B&&R>x){M._leafletCollision=!0,w.ApplyCluster(v);break}}}M._leafletCollision||g.push(v)}for(l.forEach(function(e){var i=void 0,r=e.data;if(r._leafletCollision)return r._leafletCollision=!1,r._leafletOldPopulation=0,void(r._leafletOldHashCode=0);var a=new L.LatLng(e.averagePosition.lat,e.averagePosition.lng),n=r._leafletMarker;n&&(1===e.population&&1===r._leafletOldPopulation&&e.hashCode===n._hashCode?((o||n._zoomLevel!==s||e.lastMarker.data.forceIconRedraw)&&(t.PrepareLeafletMarker(n,e.lastMarker.data,e.lastMarker.category),e.lastMarker.data.forceIconRedraw&&(e.lastMarker.data.forceIconRedraw=!1)),n.setLatLng(a),i=n):e.population>1&&r._leafletOldPopulation>1&&(n._zoomLevel===s||r._leafletPosition.equals(a))&&(n.setLatLng(a),(o||e.population!=r._leafletOldPopulation||e.hashCode!==r._leafletOldHashCode)&&n.setIcon(t.BuildLeafletClusterIcon(e)),r._leafletOldPopulation=e.population,r._leafletOldHashCode=e.hashCode,i=n)),i?(i._removeFromMap=!1,u.push(e),i._zoomLevel=s,i._hashCode=e.hashCode,i._population=e.population,r._leafletMarker=i,r._leafletPosition=a):(c.push(e),r._leafletPosition=a,r._leafletOldPopulation=e.population,r._leafletOldHashCode=e.hashCode)}),d=0,m=h.length;m>d;++d){v=h[d];var A=v.data;if(_=A._leafletMarker,A._leafletMarker._removeFromMap){var O=!0;if(_._zoomLevel===s){var E=v.averagePosition;for(C=(v.bounds.maxLat-v.bounds.minLat)*r,k=(v.bounds.maxLng-v.bounds.minLng)*r,P=0,y=c.length;y>P;++P){var z=c[P],T=z.data,F=z.averagePosition,V=E.lng-k,U=F.lng+k;if(b=E.lng+k,x=E.lat-C,I=E.lat+C,S=F.lng-k,B=F.lat-C,R=F.lat+C,b>S&&U>V&&I>B&&R>x&&(1===_._population&&1===z.population&&_._hashCode===z.hashCode?((o||z.lastMarker.data.forceIconRedraw)&&(this.PrepareLeafletMarker(_,z.lastMarker.data,z.lastMarker.category),z.lastMarker.data.forceIconRedraw&&(z.lastMarker.data.forceIconRedraw=!1)),_.setLatLng(T._leafletPosition),O=!1):_._population>1&&z.population>1&&(_.setLatLng(T._leafletPosition),_.setIcon(this.BuildLeafletClusterIcon(z)),T._leafletOldPopulation=z.population,T._leafletOldHashCode=z.hashCode,_._population=z.population,O=!1),!O)){T._leafletMarker=_,_._removeFromMap=!1,u.push(z),c.splice(P,1),--P,--y;break}}}O&&(_._removeFromMap||console.error("wtf"))}}for(d=0,m=c.length;m>d;++d){v=c[d],A=v.data;var j,N=A._leafletPosition;j=1===v.population?this.BuildLeafletMarker(v.lastMarker,N):this.BuildLeafletCluster(v,N),j.addTo(e),j.setOpacity(0),f.push(j),A._leafletMarker=j,j._zoomLevel=s,j._hashCode=v.hashCode,j._population=v.population,u.push(v)}if(window.setTimeout(function(){for(d=0,m=f.length;m>d;++d){var t=f[d];t._icon&&L.DomUtil.addClass(t._icon,"prunecluster-anim"),t._shadow&&L.DomUtil.addClass(t._shadow,"prunecluster-anim"),t.setOpacity(1)}},1),this._hardMove)for(d=0,m=p.length;m>d;++d)_=p[d],_._removeFromMap&&e.removeLayer(_);else{if(0!==this._removeTimeoutId)for(window.clearTimeout(this._removeTimeoutId),d=0,m=this._markersRemoveListTimeout.length;m>d;++d)e.removeLayer(this._markersRemoveListTimeout[d]);var D=[];for(d=0,m=p.length;m>d;++d)_=p[d],_._removeFromMap&&(_.setOpacity(0),D.push(_));D.length>0&&(this._removeTimeoutId=window.setTimeout(function(){for(d=0,m=D.length;m>d;++d)e.removeLayer(D[d]);t._removeTimeoutId=0},300)),this._markersRemoveListTimeout=D}this._objectsOnMap=u,this._hardMove=!1,this._resetIcons=!1}},FitBounds:function(){var t=this.Cluster.ComputeGlobalBounds();t&&this._map.fitBounds(new L.LatLngBounds(new L.LatLng(t.minLat,t.maxLng),new L.LatLng(t.maxLat,t.minLng)))},GetMarkers:function(){return this.Cluster.GetMarkers()},RedrawIcons:function(t){void 0===t&&(t=!0),this._resetIcons=!0,t&&this.ProcessView()}}),PruneClusterLeafletSpiderfier=(L.Layer?L.Layer:L.Class).extend({_2PI:2*Math.PI,_circleFootSeparation:25,_circleStartAngle:Math.PI/6,_spiralFootSeparation:28,_spiralLengthStart:11,_spiralLengthFactor:5,_spiralCountTrigger:8,spiderfyDistanceMultiplier:1,initialize:function(t){this._cluster=t,this._currentMarkers=[],this._multiLines=!!L.multiPolyline,this._lines=this._multiLines?L.multiPolyline([],{weight:1.5,color:"#222"}):L.polyline([],{weight:1.5,color:"#222"})},onAdd:function(t){this._map=t,this._map.on("overlappingmarkers",this.Spiderfy,this),this._map.on("click",this.Unspiderfy,this),this._map.on("zoomend",this.Unspiderfy,this)},Spiderfy:function(t){var e=this;if(t.cluster===this._cluster){this.Unspiderfy();var i=t.markers.filter(function(t){return!t.filtered});this._currentCenter=t.center;var s,r=this._map.latLngToLayerPoint(t.center);i.length>=this._spiralCountTrigger?s=this._generatePointsSpiral(i.length,r):(this._multiLines&&(r.y+=10),s=this._generatePointsCircle(i.length,r));for(var o=[],a=[],n=[],l=0,h=s.length;h>l;++l){var u=this._map.layerPointToLatLng(s[l]),p=this._cluster.BuildLeafletMarker(i[l],t.center);p.setZIndexOffset(5e3),p.setOpacity(0),this._currentMarkers.push(p),this._map.addLayer(p),a.push(p),n.push(u)}window.setTimeout(function(){for(l=0,h=s.length;h>l;++l)a[l].setLatLng(n[l]).setOpacity(1);var i=+new Date,r=42,u=290,p=window.setInterval(function(){o=[];var r=+new Date,a=r-i;if(a>=u)window.clearInterval(p),d=1;else var d=a/u;var m=t.center;for(l=0,h=s.length;h>l;++l){var _=n[l],c=_.lat-m.lat,f=_.lng-m.lng;o.push([m,new L.LatLng(m.lat+c*d,m.lng+f*d)])}e._lines.setLatLngs(o)},r)},1),this._lines.setLatLngs(o),this._map.addLayer(this._lines),this._clusterMarker=t.marker.setOpacity(.3)}},_generatePointsCircle:function(t,e){var i,s,r=this.spiderfyDistanceMultiplier*this._circleFootSeparation*(2+t),o=r/this._2PI,a=this._2PI/t,n=[];for(n.length=t,i=t-1;i>=0;i--)s=this._circleStartAngle+i*a,n[i]=new L.Point(Math.round(e.x+o*Math.cos(s)),Math.round(e.y+o*Math.sin(s)));return n},_generatePointsSpiral:function(t,e){var i,s=this.spiderfyDistanceMultiplier*this._spiralLengthStart,r=this.spiderfyDistanceMultiplier*this._spiralFootSeparation,o=this.spiderfyDistanceMultiplier*this._spiralLengthFactor,a=0,n=[];for(n.length=t,i=t-1;i>=0;i--)a+=r/s+5e-4*i,n[i]=new L.Point(Math.round(e.x+s*Math.cos(a)),Math.round(e.y+s*Math.sin(a))),s+=this._2PI*o/a;return n},Unspiderfy:function(){for(var t=this,e=0,i=this._currentMarkers.length;i>e;++e)this._currentMarkers[e].setLatLng(this._currentCenter).setOpacity(0);var s=this._currentMarkers;window.setTimeout(function(){for(e=0,i=s.length;i>e;++e)t._map.removeLayer(s[e])},300),this._currentMarkers=[],this._map.removeLayer(this._lines),this._clusterMarker&&this._clusterMarker.setOpacity(1)},onRemove:function(t){this.Unspiderfy(),t.off("overlappingmarkers",this.Spiderfy,this),t.off("click",this.Unspiderfy,this),t.off("zoomend",this.Unspiderfy,this)}});
//# sourceMappingURL=PruneCluster.min.js.map
